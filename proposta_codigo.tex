\chapter{Proposta de um esqueleto de código padrão}

Por fim, resumindo-se tudo o que foi já foi dito e usando como base a implementação em CUDA, que se mostrou a mais eficiente, é apresentado um esqueleto padrão de código que soluciona o problema proposto de forma simplificada. Esse esqueleto visa facilitar o trabalho de adaptação de algoritmos sequenciais de análise e processamento de dados atmosféricos em uma solução paralela do mesmo. 

O código contém duas estruturas de variáveis, nomeadas \texttt{parametros} e \texttt{parametros\_exec} que armazenam, respectivamente, os parâmetros de entrada e os parâmetros de execução da função em CUDA. Por sua vez, os parâmetros de execução são calculados pela função \texttt{calcula\_parametros\_execucao}, que tem como argumentos o número de pontos e o tamanho das séries do dado de entrada. Os parâmetros de entrada são lidos pela função \texttt{le\_parametros\_entrada}.

Os dados de entrada são lidos, e reorganizados da forma previamente descrita, pela função \texttt{le\_matriz\_entrada} e são apontados pela variável \texttt{d\_entrada}. Após a leitura dos dados, inicia-se o processo de inicialização e configuração do device para que o mesmo seja capaz de executar as tarefas necessárias. Esse processo começa com a alocação de espaço na memória do device para armazenar os dados de entrada e saída, igualmente como é feito em qualquer outro programa, e para isso utiliza a função \texttt{cudaMalloc} da biblioteca CUDA, a qual se assemelha muito com a função \texttt{malloc}. A grande diferença desse passo para o que normalmente feito é que o espaço alocado não é para armazenar todo o dado de entrada mas apenas uma parte desse, a qual será processada em cada ciclo.

Após esse passo inicia-se o laço de ciclos. Em cada um desses ciclos serão executados os passos descritos na seção \ref{cap:implementacao_solucao}. Para copiar os dados entre o host e o device é usado a função \texttt{cudaMemcpy}.


 e a função \texttt{cudaDeviceSynchronize} garante que a execução do código principal só continue quando o todo o processamento no device termine.

Quando todos os ciclos terminarem, os resultados são escritos em disco pela função \texttt{salva\_arq\_saida} no mesmo formato do dado de entrada e as variáveis

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Definicao do estilo dos codigos
%Baseado em:
%http://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings

\definecolor{mygray}{rgb}{0.5,0.5,0.5}

\lstdefinestyle{code_style}{
language=C,
breaklines=true,
frame=tb,
commentstyle=\color{mygray},
basicstyle=\footnotesize,
numbers=left,
numbersep=5pt,
numberstyle=\color{mygray},
tabsize=2,
showtabs=false
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\lstinputlisting[caption=esqueleto\_codigo.h, style=code_style]{Codigos/esqueleto_codigo.h}
\lstinputlisting[caption=esqueleto\_codigo.c, style=code_style]{Codigos/esqueleto_codigo.c}